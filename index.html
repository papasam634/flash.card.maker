<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—ç‰¹è¨“ç­ (YAML æ“´å……ç‰ˆ)</title>
    <!-- è§£æ YAML ç”¨çš„å¥—ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden-force { display: none !important; }
        
        body { font-family: sans-serif; background: #f3f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 800px; min-height: 600px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        
        .nav-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .nav-btn.inactive { background-color: #f3f4f6; color: #4b5563; }
        .nav-btn.inactive:hover { background-color: #e5e7eb; }

        .shake { animation: shake 0.3s ease-in-out; border-color: #ef4444 !important; color: #ef4444 !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* è®€å–ä¸­çš„è½‰åœˆåœˆ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: white;">
            <div style="display: flex; align-items: center;">
                <h1 style="margin: 0; font-size: 20px; color: #374151;">ğŸ”€ å–®å­—ç‰¹è¨“ç­</h1>
                <span id="loading-indicator" style="margin-left: 15px; font-size: 12px; color: #6b7280; display: none;">
                    <div class="loader"></div> è¼‰å…¥é¡Œåº«ä¸­...
                </span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="btn-manage" class="nav-btn active">1. å–®å­—ç®¡ç†</button>
                <button id="btn-quiz" class="nav-btn inactive">2. éš¨æ©Ÿæ¸¬é©—</button>
            </div>
        </div>

        <!-- ç®¡ç†é  -->
        <div id="view-manage" style="padding: 24px; flex: 1; display: flex; flex-direction: column;">
            
            <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dbeafe;">
                <h3 style="margin-top: 0; margin-bottom: 12px; color: #1e40af;">â• æ‰‹å‹•æ–°å¢å–®å­—</h3>
                <form id="add-form" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <input id="input-spelling" placeholder="è‹±æ–‡ (Apple)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; min-width: 120px;">
                    <input id="input-meaning" placeholder="ä¸­æ–‡ (è˜‹æœ)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; min-width: 120px;">
                    <input id="input-pos" placeholder="è©æ€§ (n.)" required style="flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; min-width: 60px;">
                    <button type="submit" style="flex: 1; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 8px;">æ–°å¢</button>
                </form>
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #6b7280; font-size: 14px;">
                    æœ¬åœ°ï¼š<span id="count-local" style="font-weight: bold;">0</span> | 
                    å¤–éƒ¨åŒ¯å…¥ï¼š<span id="count-remote" style="font-weight: bold;">0</span>
                </span>
                <button id="btn-reset" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 12px; text-decoration: underline;">æ¸…é™¤æœ¬åœ°è³‡æ–™</button>
            </div>

            <div style="flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; position: relative;">
                <div style="overflow-y: auto; height: 100%; max-height: 400px;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead style="background: #f9fafb; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; width: 30%;">è‹±æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; width: 30%;">ä¸­æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; width: 20%;">è©æ€§</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right;">ä¾†æº</th>
                            </tr>
                        </thead>
                        <tbody id="word-list-body"></tbody>
                    </table>
                    <div id="list-empty-msg" style="display: none; text-align: center; padding: 40px; color: #9ca3af;">æš«ç„¡å–®å­—</div>
                </div>
            </div>
        </div>

        <!-- æ¸¬é©—é  -->
        <div id="view-quiz" class="hidden-force" style="padding: 24px; flex: 1; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <div style="width: 100%; height: 4px; background: #e5e7eb; margin-bottom: 8px; border-radius: 2px;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 40px;">æœ¬è¼ªå‰©é¤˜ï¼š<span id="queue-count">0</span> é¡Œ</div>

            <div id="quiz-card" style="width: 100%; max-width: 400px; margin: 0 auto;">
                <div style="margin-bottom: 20px;">
                    <span id="quiz-pos" style="background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 12px;">è©æ€§</span>
                    <h2 id="quiz-meaning" style="font-size: 32px; margin: 16px 0; color: #1f2937;">(é¡Œç›®)</h2>
                </div>

                <div style="position: relative; margin-bottom: 20px;">
                    <input id="quiz-input" type="text" placeholder="è¼¸å…¥æ‹¼å­—..." autocomplete="off"
                           style="width: 100%; text-align: center; font-size: 24px; border: none; border-bottom: 2px solid #d1d5db; padding: 10px; outline: none; background: transparent;">
                    <div id="quiz-msg" style="height: 20px; margin-top: 8px; font-size: 14px; font-weight: bold;"></div>
                </div>

                <button id="btn-next" class="hidden-force" style="width: 100%; background: #22c55e; color: white; font-size: 18px; font-weight: bold; padding: 12px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ä¸‹ä¸€é¡Œ â”
                </button>
            </div>

            <div id="quiz-empty-msg" class="hidden-force">
                <p style="font-size: 18px; color: #6b7280;">é¡Œåº«æ˜¯ç©ºçš„ï¼</p>
            </div>
        </div>
    </div>

    <script>
        // === è¨­å®šå€ï¼šè«‹åœ¨é€™è£¡åˆ—å‡ºæ‰€æœ‰è¦è¼‰å…¥çš„ YAML æª”å ===
        const YAML_FILES = [
            'words.yml',
            // 'toeic.yml',  <-- å¦‚æœæœ‰æ›´å¤šæª”æ¡ˆï¼Œä¾æ­¤é¡æ¨
        ];
        // ==========================================

        const STORAGE_KEY = 'vocab_app_local';
        let localWords = [];   // æ‰‹å‹•è¼¸å…¥çš„ (å­˜ localStorage)
        let remoteWords = [];  // å¾ YAML è®€ä¾†çš„ (å”¯è®€)
        let allWords = [];     // åˆä½µå¾Œçš„ç¸½è¡¨
        let quizQueue = [];
        let currentWord = null;

        const el = {
            btnManage: document.getElementById('btn-manage'),
            btnQuiz: document.getElementById('btn-quiz'),
            viewManage: document.getElementById('view-manage'),
            viewQuiz: document.getElementById('view-quiz'),
            inputSpelling: document.getElementById('input-spelling'),
            addForm: document.getElementById('add-form'),
            quizInput: document.getElementById('quiz-input'),
            loading: document.getElementById('loading-indicator')
        };

        window.onload = function() {
            el.btnManage.onclick = () => goToTab('manage');
            el.btnQuiz.onclick = () => goToTab('quiz');
            el.addForm.onsubmit = handleAddWord;
            document.getElementById('btn-reset').onclick = resetLocalData;
            document.getElementById('btn-next').onclick = nextQuestion;

            el.quizInput.oninput = checkAnswer;
            el.quizInput.onkeydown = (e) => {
                if (e.key === 'Enter' && !document.getElementById('btn-next').classList.contains('hidden-force')) {
                    nextQuestion();
                }
            };

            loadData(); // è¼‰å…¥æœ¬åœ°
            loadRemoteYamls(); // è¼‰å…¥é ç«¯
        };

        // --- è®€å– YAML æª”æ¡ˆ ---
        async function loadRemoteYamls() {
            el.loading.style.display = 'inline-block';
            remoteWords = [];

            try {
                const promises = YAML_FILES.map(filename => 
                    fetch(filename)
                        .then(res => {
                            if (!res.ok) throw new Error(`ç„¡æ³•è®€å– ${filename}`);
                            return res.text();
                        })
                        .then(text => jsyaml.load(text)) // ä½¿ç”¨ js-yaml è§£æ
                        .catch(err => {
                            console.warn(`è®€å– ${filename} å¤±æ•—:`, err);
                            return [];
                        })
                );

                const results = await Promise.all(promises);
                
                // åˆä½µæ‰€æœ‰æª”æ¡ˆçš„çµæœ
                results.forEach(data => {
                    if (Array.isArray(data)) {
                        // åŠ ä¸Šæ¨™è¨˜å€åˆ†ä¾†æº
                        const labeled = data.map(w => ({
                            id: 'remote_' + Math.random().toString(36).substr(2, 9),
                            s: w.spelling, 
                            m: w.meaning, 
                            p: w.pos, 
                            isRemote: true
                        }));
                        remoteWords = remoteWords.concat(labeled);
                    }
                });

                combineAndRender();

            } catch (e) {
                console.error("YAML è¼‰å…¥ç¸½é«”å¤±æ•—", e);
            } finally {
                el.loading.style.display = 'none';
            }
        }

        // --- è³‡æ–™è™•ç† ---
        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) localWords = JSON.parse(raw);
            } catch (e) { localWords = []; }
        }

        function combineAndRender() {
            // åˆä½µ æœ¬åœ° + é ç«¯
            allWords = [...localWords, ...remoteWords];
            renderList();
        }

        function handleAddWord(e) {
            e.preventDefault();
            const s = el.inputSpelling.value.trim();
            const m = document.getElementById('input-meaning').value.trim();
            const p = document.getElementById('input-pos').value.trim();
            if (!s || !m) return;

            localWords.unshift({ id: Date.now(), s, m, p, isRemote: false });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            
            e.target.reset();
            el.inputSpelling.focus();
            combineAndRender();
        }

        function deleteLocalWord(id) {
            localWords = localWords.filter(w => w.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            combineAndRender();
        }

        function resetLocalData() {
            if(!confirm('ç¢ºå®šæ¸…ç©ºã€Œæœ¬åœ°æ‰‹å‹•è¼¸å…¥ã€çš„å–®å­—ï¼Ÿ(YAML åŒ¯å…¥çš„å–®å­—ä¸æœƒæ¶ˆå¤±)')) return;
            localWords = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            combineAndRender();
        }

        function renderList() {
            const tbody = document.getElementById('word-list-body');
            tbody.innerHTML = '';
            
            document.getElementById('count-local').innerText = localWords.length;
            document.getElementById('count-remote').innerText = remoteWords.length;

            if (allWords.length === 0) {
                document.getElementById('list-empty-msg').style.display = 'block';
            } else {
                document.getElementById('list-empty-msg').style.display = 'none';
                
                // ç‚ºäº†æ•ˆèƒ½ï¼Œåªé¡¯ç¤ºå‰ 100 ç­† (å¦‚æœé¡Œåº«å¾ˆå¤§çš„è©±)
                // æˆ–æ˜¯ç›´æ¥é¡¯ç¤ºå…¨éƒ¨ï¼Œè¦–æ‚¨çš„é¡Œåº«å¤§å°è€Œå®š
                allWords.slice(0, 200).forEach(w => {
                    const tr = document.createElement('tr');
                    
                    // æ“ä½œæŒ‰éˆ•ï¼šå¦‚æœæ˜¯é ç«¯çš„é¡¯ç¤ºé–é ­ï¼Œæœ¬åœ°çš„é¡¯ç¤ºåˆªé™¤
                    const actionBtn = w.isRemote 
                        ? `<span style="color:#9ca3af; font-size:12px;">ğŸ”’ å”¯è®€</span>`
                        : `<button onclick="deleteLocalWord(${w.id})" style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold;">âœ•</button>`;

                    const sourceLabel = w.isRemote 
                        ? `<span style="background:#ecfdf5; color:#047857; padding:2px 6px; border-radius:4px; font-size:11px;">åŒ¯å…¥</span>`
                        : `<span style="background:#eff6ff; color:#1d4ed8; padding:2px 6px; border-radius:4px; font-size:11px;">æœ¬åœ°</span>`;

                    tr.innerHTML = `
                        <td style="padding:12px; color:#2563eb; font-family:monospace; font-size:15px;">${w.s}</td>
                        <td style="padding:12px;">${w.m}</td>
                        <td style="padding:12px;"><span style="background:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:12px;">${w.p}</span></td>
                        <td style="padding:12px; text-align:right;">${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- æ¸¬é©—é‚è¼¯ ---
        function goToTab(tabName) {
            if (tabName === 'manage') {
                el.viewManage.classList.remove('hidden-force');
                el.viewManage.style.display = 'flex';
                el.viewQuiz.classList.add('hidden-force');
                el.viewQuiz.style.display = 'none';
                el.btnManage.className = 'nav-btn active';
                el.btnQuiz.className = 'nav-btn inactive';
            } else {
                el.viewQuiz.classList.remove('hidden-force');
                el.viewQuiz.style.display = 'flex';
                el.viewManage.classList.add('hidden-force');
                el.viewManage.style.display = 'none';
                el.btnManage.className = 'nav-btn inactive';
                el.btnQuiz.className = 'nav-btn active';
                initQuiz();
            }
        }

        function initQuiz() {
            if (allWords.length === 0) {
                document.getElementById('quiz-card').classList.add('hidden-force');
                document.getElementById('quiz-empty-msg').classList.remove('hidden-force');
            } else {
                document.getElementById('quiz-empty-msg').classList.add('hidden-force');
                document.getElementById('quiz-card').classList.remove('hidden-force');
                
                // é‡æ–°é€²å…¥æ¸¬é©—æ™‚ï¼Œå¦‚æœæ²’æœ‰æ­£åœ¨é€²è¡Œçš„é¡Œç›®ï¼Œæ‰æ›ä¸‹ä¸€é¡Œ
                // æˆ–è€…ä½‡åˆ—ç‚ºç©ºæ™‚ï¼Œå…ˆå¼·åˆ¶æ´—ç‰Œä¸€æ¬¡
                if (quizQueue.length === 0 && !currentWord) {
                     // åˆæ¬¡é€²å…¥ï¼Œå¼·åˆ¶æ´—ç‰Œ
                     refillQueue(); 
                     nextQuestion();
                } else if (!currentWord) {
                     nextQuestion();
                }
            }
        }

        function refillQueue() {
            // è¤‡è£½ä¸€ä»½ç¸½è¡¨ä¸¦æ´—ç‰Œ
            let temp = [...allWords];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            quizQueue = temp;
        }

        function nextQuestion() {
            if (allWords.length === 0) return;

            if (quizQueue.length === 0) {
                refillQueue();
            }

            currentWord = quizQueue.pop();
            updateProgress();

            // UI Reset
            el.quizInput.value = '';
            el.quizInput.disabled = false;
            el.quizInput.style.color = 'black';
            el.quizInput.style.borderBottomColor = '#d1d5db';
            document.getElementById('quiz-msg').innerText = '';
            document.getElementById('btn-next').classList.add('hidden-force');
            
            document.getElementById('quiz-meaning').innerText = currentWord.m;
            document.getElementById('quiz-pos').innerText = currentWord.p;

            setTimeout(() => el.quizInput.focus(), 50);
        }

        function checkAnswer(e) {
            if (!currentWord) return;
            const val = e.target.value;
            const target = currentWord.s;
            const msg = document.getElementById('quiz-msg');

            if (val === target) {
                e.target.disabled = true;
                e.target.style.color = '#16a34a';
                e.target.style.borderBottomColor = '#16a34a';
                msg.innerText = 'ğŸ‰ Correct!';
                msg.style.color = '#16a34a';
                document.getElementById('btn-next').classList.remove('hidden-force');
                document.getElementById('btn-next').focus();
                return;
            }

            if (!target.startsWith(val)) {
                e.target.classList.add('shake');
                msg.innerText = 'âŒ æ‹¼å­—éŒ¯èª¤';
                msg.style.color = '#ef4444';
                setTimeout(() => e.target.classList.remove('shake'), 300);
            } else {
                e.target.classList.remove('shake');
                e.target.style.borderBottomColor = '#d1d5db';
                e.target.style.color = 'black';
                msg.innerText = '';
            }
        }

        function updateProgress() {
            const total = allWords.length || 1;
            const remain = quizQueue.length;
            const percent = ((total - remain) / total) * 100;
            document.getElementById('queue-count').innerText = remain;
            document.getElementById('progress-bar').style.width = percent + '%';
        }
    </script>
</body>
</html>
