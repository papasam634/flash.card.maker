<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—ç‰¹è¨“ç­ (JSON ç©©å®šç‰ˆ)</title>
    <!-- ç‚ºäº†ç¾è§€ä¿ç•™ Tailwindï¼Œä½†ç§»é™¤ä¹Ÿä¸å½±éŸ¿åŠŸèƒ½ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === æ ¸å¿ƒæ¨£å¼ (ä¸ä¾è³´ Tailwind) === */
        .hidden-force { display: none !important; }
        
        body { font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 800px; min-height: 600px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        
        .nav-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; background: #f3f4f6; color: #4b5563; }
        .nav-btn:hover { background-color: #e5e7eb; }
        .nav-btn.active { background-color: #2563eb; color: white; } 

        .shake { animation: shake 0.3s ease-in-out; border-color: #ef4444 !important; color: #ef4444 !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: white;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1 style="margin: 0; font-size: 20px; color: #374151;">ğŸ”€ å–®å­—ç‰¹è¨“ç­</h1>
                <span id="status-msg" style="font-size: 12px; color: #6b7280;"></span>
            </div>
            <div style="display: flex; gap: 8px;">
                <!-- ç›´æ¥åœ¨ HTML ç¶å®š onclickï¼Œé€™æ˜¯æœ€ä¸æœƒå£çš„æ–¹æ³• -->
                <button id="btn-manage" class="nav-btn active" onclick="switchTab('manage')">1. å–®å­—ç®¡ç†</button>
                <button id="btn-quiz" class="nav-btn" onclick="switchTab('quiz')">2. éš¨æ©Ÿæ¸¬é©—</button>
            </div>
        </div>

        <!-- åˆ†é  1: ç®¡ç† -->
        <div id="view-manage" style="padding: 24px; flex: 1; display: flex; flex-direction: column;">
            
            <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dbeafe;">
                <h3 style="margin-top: 0; margin-bottom: 12px; color: #1e40af;">â• æ‰‹å‹•æ–°å¢</h3>
                <form id="add-form" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <input id="input-spelling" placeholder="è‹±æ–‡ (Apple)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <input id="input-meaning" placeholder="ä¸­æ–‡ (è˜‹æœ)" required style="flex: 2; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <input id="input-pos" placeholder="è©æ€§ (n.)" required style="flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                    <button type="submit" style="flex: 1; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; padding: 8px;">æ–°å¢</button>
                </form>
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #6b7280; font-size: 14px;">
                    æœ¬åœ°ï¼š<span id="cnt-local" style="font-weight: bold;">0</span> | 
                    å¤–éƒ¨(JSON)ï¼š<span id="cnt-remote" style="font-weight: bold;">0</span>
                </span>
                <button onclick="resetLocalData()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 12px; text-decoration: underline;">æ¸…ç©ºæœ¬åœ°</button>
            </div>

            <div style="flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; position: relative;">
                <div style="overflow-y: auto; height: 100%; max-height: 400px;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead style="background: #f9fafb; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">è‹±æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">ä¸­æ–‡</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb;">è©æ€§</th>
                                <th style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right;">ä¾†æº</th>
                            </tr>
                        </thead>
                        <tbody id="word-list-body"></tbody>
                    </table>
                    <div id="list-empty-msg" style="display: none; text-align: center; padding: 40px; color: #9ca3af;">æš«ç„¡å–®å­—</div>
                </div>
            </div>
        </div>

        <!-- åˆ†é  2: æ¸¬é©— -->
        <div id="view-quiz" class="hidden-force" style="padding: 24px; flex: 1; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <div style="width: 100%; height: 4px; background: #e5e7eb; margin-bottom: 8px; border-radius: 2px;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 40px;">æœ¬è¼ªå‰©é¤˜ï¼š<span id="queue-count">0</span> é¡Œ</div>

            <div id="quiz-card" style="width: 100%; max-width: 400px; margin: 0 auto;">
                <div style="margin-bottom: 20px;">
                    <span id="quiz-pos" style="background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 12px;">è©æ€§</span>
                    <h2 id="quiz-meaning" style="font-size: 32px; margin: 16px 0; color: #1f2937;">(é¡Œç›®)</h2>
                </div>

                <div style="position: relative; margin-bottom: 20px;">
                    <input id="quiz-input" type="text" placeholder="è¼¸å…¥æ‹¼å­—..." autocomplete="off"
                           style="width: 100%; text-align: center; font-size: 24px; border: none; border-bottom: 2px solid #d1d5db; padding: 10px; outline: none; background: transparent;">
                    <div id="quiz-msg" style="height: 20px; margin-top: 8px; font-size: 14px; font-weight: bold;"></div>
                </div>

                <button id="btn-next" class="hidden-force" onclick="nextQuestion()" style="width: 100%; background: #22c55e; color: white; font-size: 18px; font-weight: bold; padding: 12px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ä¸‹ä¸€é¡Œ â”
                </button>
            </div>

            <div id="quiz-empty-msg" class="hidden-force">
                <p style="font-size: 18px; color: #6b7280;">é¡Œåº«æ˜¯ç©ºçš„ï¼</p>
                <button onclick="switchTab('manage')" style="color: #2563eb; text-decoration: underline; background: none; border: none; cursor: pointer;">å›é¦–é æ–°å¢æˆ–æª¢æŸ¥ JSON</button>
            </div>
        </div>
    </div>

    <script>
        // === è¨­å®šå€ï¼šJSON æª”æ¡ˆåˆ—è¡¨ ===
        const JSON_FILES = ['words.json']; 
        const STORAGE_KEY = 'vocab_app_json_v1';

        // === ç‹€æ…‹è®Šæ•¸ ===
        let localWords = [];
        let remoteWords = [];
        let allWords = [];
        let quizQueue = [];
        let currentWord = null;

        // === ç¨‹å¼å…¥å£ (ç¢ºä¿ UI å…ˆèƒ½å‹•) ===
        window.onload = function() {
            // 1. å…ˆåˆå§‹åŒ– UI äº‹ä»¶ (ç¢ºä¿æŒ‰éˆ•ä¸€å®šæœ‰æ•ˆ)
            document.getElementById('add-form').onsubmit = handleAddWord;
            document.getElementById('quiz-input').oninput = checkAnswer;
            document.getElementById('quiz-input').onkeydown = (e) => {
                if (e.key === 'Enter' && !document.getElementById('btn-next').classList.contains('hidden-force')) {
                    nextQuestion();
                }
            };

            // 2. è¼‰å…¥æœ¬åœ°è³‡æ–™
            loadLocalData();

            // 3. æœ€å¾Œæ‰å»æŠ“å¤–éƒ¨è³‡æ–™ (é¿å…å¡ä½ UI)
            loadRemoteData();
        };

        // === æ ¸å¿ƒ 1: åˆ†é åˆ‡æ› (æœ€ç©©å®šçš„å¯«æ³•) ===
        function switchTab(tab) {
            const viewManage = document.getElementById('view-manage');
            const viewQuiz = document.getElementById('view-quiz');
            const btnManage = document.getElementById('btn-manage');
            const btnQuiz = document.getElementById('btn-quiz');

            if (tab === 'manage') {
                viewManage.classList.remove('hidden-force');
                viewManage.style.display = 'flex';
                viewQuiz.classList.add('hidden-force');
                
                btnManage.classList.add('active');
                btnQuiz.classList.remove('active');
            } else {
                viewManage.classList.add('hidden-force');
                viewQuiz.classList.remove('hidden-force');
                viewQuiz.style.display = 'flex';

                btnManage.classList.remove('active');
                btnQuiz.classList.add('active');
                
                // åˆ‡æ›éä¾†æ™‚ï¼Œå¦‚æœé‚„æ²’é¡Œç›®ï¼Œå°±å‡ºé¡Œ
                initQuiz();
            }
        }

        // === æ ¸å¿ƒ 2: è³‡æ–™è¼‰å…¥ ===
        function loadLocalData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) localWords = JSON.parse(raw);
            } catch (e) { localWords = []; }
            updateAllWords();
        }

        async function loadRemoteData() {
            const status = document.getElementById('status-msg');
            status.innerText = 'è¼‰å…¥ JSON ä¸­...';
            remoteWords = [];

            for (const file of JSON_FILES) {
                try {
                    const res = await fetch(file);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    
                    if (Array.isArray(data)) {
                        // åŠ ä¸Šæ¨™è¨˜
                        const labeled = data.map(w => ({
                            id: 'json_' + Math.random().toString(36).substr(2),
                            s: w.spelling,
                            m: w.meaning,
                            p: w.pos,
                            isRemote: true
                        }));
                        remoteWords = remoteWords.concat(labeled);
                    }
                } catch (err) {
                    console.warn(`ç„¡æ³•è¼‰å…¥ ${file}:`, err);
                    // ä¸å ±éŒ¯çµ¦ä½¿ç”¨è€…ï¼Œé¿å…å¹²æ“¾é«”é©—
                }
            }
            status.innerText = ''; // æ¸…é™¤è¼‰å…¥è¨Šæ¯
            updateAllWords();
        }

        function updateAllWords() {
            allWords = [...localWords, ...remoteWords];
            renderList();
        }

        // === æ ¸å¿ƒ 3: ç®¡ç†åŠŸèƒ½ ===
        function handleAddWord(e) {
            e.preventDefault();
            const s = document.getElementById('input-spelling').value.trim();
            const m = document.getElementById('input-meaning').value.trim();
            const p = document.getElementById('input-pos').value.trim();
            if (!s || !m) return;

            localWords.unshift({ id: Date.now(), s, m, p, isRemote: false });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            
            e.target.reset();
            document.getElementById('input-spelling').focus();
            updateAllWords();
        }

        function deleteLocalWord(id) {
            localWords = localWords.filter(w => w.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            updateAllWords();
        }

        function resetLocalData() {
            if(!confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) return;
            localWords = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localWords));
            updateAllWords();
        }

        function renderList() {
            const tbody = document.getElementById('word-list-body');
            tbody.innerHTML = '';
            document.getElementById('cnt-local').innerText = localWords.length;
            document.getElementById('cnt-remote').innerText = remoteWords.length;

            if (allWords.length === 0) {
                document.getElementById('list-empty-msg').style.display = 'block';
            } else {
                document.getElementById('list-empty-msg').style.display = 'none';
                
                // æ¸²æŸ“å‰ 200 ç­†
                allWords.slice(0, 200).forEach(w => {
                    const tr = document.createElement('tr');
                    const badge = w.isRemote 
                        ? `<span style="background:#d1fae5; color:#065f46; padding:2px 6px; rounded:4px; font-size:11px;">JSON</span>` 
                        : `<span style="background:#dbeafe; color:#1e40af; padding:2px 6px; rounded:4px; font-size:11px;">æœ¬åœ°</span>`;
                    
                    const action = w.isRemote
                        ? `<span style="color:#9ca3af; font-size:12px;">ğŸ”’</span>`
                        : `<button onclick="deleteLocalWord(${w.id})" style="color:#ef4444; background:none; border:none; cursor:pointer;">âœ•</button>`;

                    tr.innerHTML = `
                        <td style="padding:12px; color:#2563eb; font-family:monospace;">${w.s}</td>
                        <td style="padding:12px;">${w.m}</td>
                        <td style="padding:12px;"><span style="background:#f3f4f6; padding:2px 6px; border-radius:4px; font-size:12px;">${w.p}</span></td>
                        <td style="padding:12px; text-align:right; display:flex; align-items:center; justify-content:flex-end; gap:8px;">${badge} ${action}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // === æ ¸å¿ƒ 4: æ¸¬é©—åŠŸèƒ½ ===
        function initQuiz() {
            // å¦‚æœæ²’æœ‰é¡Œç›®
            if (allWords.length === 0) {
                document.getElementById('quiz-card').classList.add('hidden-force');
                document.getElementById('quiz-empty-msg').classList.remove('hidden-force');
                return;
            }

            document.getElementById('quiz-empty-msg').classList.add('hidden-force');
            document.getElementById('quiz-card').classList.remove('hidden-force');

            // å¦‚æœç•¶å‰æ²’æœ‰é¡Œç›®ï¼Œæˆ–è€…é¡Œç›®å·²ç¶“ç­”å®Œï¼Œå°±å‡ºæ–°é¡Œ
            if (!currentWord || !document.getElementById('btn-next').classList.contains('hidden-force')) {
                 // åªæœ‰åœ¨å‰›åˆ‡æ›éä¾†ä¸”æ²’é¡Œç›®æ™‚æ‰è‡ªå‹•å‡ºé¡Œ
                 if (!currentWord) nextQuestion();
            }
        }

        function nextQuestion() {
            if (allWords.length === 0) return;

            // æ´—ç‰Œ/è£œç‰Œ
            if (quizQueue.length === 0) {
                let temp = [...allWords];
                // Fisher-Yates æ´—ç‰Œ
                for (let i = temp.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [temp[i], temp[j]] = [temp[j], temp[i]];
                }
                quizQueue = temp;
            }

            currentWord = quizQueue.pop();
            updateProgress();

            // UI Reset
            const input = document.getElementById('quiz-input');
            input.value = '';
            input.disabled = false;
            input.style.color = 'black';
            input.style.borderBottomColor = '#d1d5db';
            
            document.getElementById('quiz-msg').innerText = '';
            document.getElementById('btn-next').classList.add('hidden-force');
            
            document.getElementById('quiz-meaning').innerText = currentWord.m;
            document.getElementById('quiz-pos').innerText = currentWord.p;

            setTimeout(() => input.focus(), 50);
        }

        function checkAnswer(e) {
            if (!currentWord) return;
            const val = e.target.value;
            const target = currentWord.s;
            const msg = document.getElementById('quiz-msg');

            if (val === target) {
                e.target.disabled = true;
                e.target.style.color = '#16a34a';
                e.target.style.borderBottomColor = '#16a34a';
                msg.innerText = 'ğŸ‰ Correct!';
                msg.style.color = '#16a34a';
                document.getElementById('btn-next').classList.remove('hidden-force');
                document.getElementById('btn-next').focus();
                return;
            }

            if (!target.startsWith(val)) {
                e.target.classList.add('shake');
                msg.innerText = 'âŒ æ‹¼å­—éŒ¯èª¤';
                msg.style.color = '#ef4444';
                setTimeout(() => e.target.classList.remove('shake'), 300);
            } else {
                e.target.classList.remove('shake');
                e.target.style.borderBottomColor = '#d1d5db';
                e.target.style.color = 'black';
                msg.innerText = '';
            }
        }

        function updateProgress() {
            const total = allWords.length || 1;
            const remain = quizQueue.length;
            const percent = ((total - remain) / total) * 100;
            document.getElementById('queue-count').innerText = remain;
            document.getElementById('progress-bar').style.width = percent + '%';
        }
    </script>
</body>
</html>
