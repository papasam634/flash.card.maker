<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—ç‰¹è¨“ç­ (æ´—ç‰Œéš¨æ©Ÿç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        
        /* æ–æ™ƒå‹•ç•« */
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* é€²åº¦æ¢å‹•ç•« */
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans flex flex-col items-center py-6 px-4">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col">
        
        <!-- Header -->
        <header class="bg-white border-b px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 sticky top-0 z-20">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ”€</span>
                <h1 class="text-xl font-bold text-gray-700">å–®å­—ç‰¹è¨“ç­</h1>
            </div>
            
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button onclick="switchTab('manage')" id="btn-manage" class="px-5 py-2 rounded-md text-sm font-bold transition-all shadow-sm bg-blue-600 text-white">
                    1. å–®å­—ç®¡ç†
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz" class="px-5 py-2 rounded-md text-sm font-bold transition-all text-gray-600 hover:bg-gray-200">
                    2. éš¨æ©Ÿæ¸¬é©—
                </button>
            </div>
        </header>

        <!-- åˆ†é  1: å–®å­—ç®¡ç† (é è¨­) -->
        <main id="view-manage" class="flex-1 p-6 flex flex-col bg-gray-50">
            
            <!-- æ–°å¢å€ -->
            <div class="bg-white border border-blue-100 rounded-xl p-5 mb-6 shadow-sm">
                <h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                    â• æ–°å¢å–®å­—
                    <span class="text-xs text-gray-400 font-normal ml-auto">æŒ‰ Enter è‡ªå‹•æ–°å¢</span>
                </h3>
                <form id="add-form" class="grid grid-cols-1 md:grid-cols-10 gap-3">
                    <div class="md:col-span-4">
                        <input type="text" id="input-spelling" placeholder="è‹±æ–‡ (Apple)" required 
                               class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none"
                               autocomplete="off">
                    </div>
                    <div class="md:col-span-3">
                        <input type="text" id="input-meaning" placeholder="ä¸­æ–‡ (è˜‹æœ)" required 
                               class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none"
                               autocomplete="off">
                    </div>
                    <div class="md:col-span-2">
                        <input type="text" id="input-pos" placeholder="è©æ€§ (n.)" required 
                               class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none"
                               autocomplete="off">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" class="w-full h-full bg-blue-600 hover:bg-blue-700 text-white font-bold rounded flex items-center justify-center py-2">
                            æ–°å¢
                        </button>
                    </div>
                </form>
            </div>

            <!-- åˆ—è¡¨å€ -->
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-sm font-bold text-gray-500">ç¸½å–®å­—é‡ï¼š<span id="word-count">0</span></span>
                <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-600 underline">æ¸…ç©ºè³‡æ–™åº«</button>
            </div>

            <div class="flex-1 border rounded-xl overflow-hidden bg-white relative shadow-inner">
                <div class="overflow-y-auto absolute inset-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="p-3 text-sm font-semibold text-gray-600 border-b">è‹±æ–‡</th>
                                <th class="p-3 text-sm font-semibold text-gray-600 border-b">ä¸­æ–‡</th>
                                <th class="p-3 text-sm font-semibold text-gray-600 border-b">è©æ€§</th>
                                <th class="p-3 text-sm font-semibold text-gray-600 border-b text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="word-list-body" class="divide-y divide-gray-100">
                            <!-- JS ç”Ÿæˆ -->
                        </tbody>
                    </table>
                    <div id="list-empty-msg" class="hidden flex flex-col items-center justify-center h-full text-gray-400">
                        <p class="text-3xl mb-2">ğŸ“‚</p>
                        <p>æš«ç„¡å–®å­—</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- åˆ†é  2: éš¨æ©Ÿæ¸¬é©— -->
        <main id="view-quiz" class="hidden flex-1 flex flex-col relative bg-slate-50">
            
            <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
            <div class="bg-slate-200 h-1 w-full">
                <div id="round-progress" class="bg-blue-500 h-1 progress-bar" style="width: 0%"></div>
            </div>
            <div class="text-center py-2 text-xs text-gray-400 bg-white border-b">
                æœ¬è¼ªå‰©é¤˜ï¼š<span id="queue-count" class="font-bold text-blue-600">0</span> é¡Œ (éš¨æ©Ÿæ´—ç‰Œä¸é‡è¤‡)
            </div>

            <!-- æ¸¬é©—æ ¸å¿ƒå€ -->
            <div class="flex-1 flex flex-col justify-center items-center p-6">
                <div id="quiz-card-container" class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8 text-center">
                    
                    <div class="mb-8">
                        <span id="quiz-pos" class="inline-block bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded mb-4">è©æ€§</span>
                        <h2 id="quiz-meaning" class="text-4xl font-bold text-gray-800 break-words leading-tight">
                            <!-- é¡Œç›® -->
                        </h2>
                    </div>

                    <div class="relative mb-8 group">
                        <input type="text" id="quiz-input" placeholder="è¼¸å…¥æ‹¼å­—..." 
                               class="w-full text-center text-3xl font-mono border-b-2 border-gray-300 bg-transparent focus:border-blue-500 outline-none py-3 transition-colors placeholder-gray-300"
                               autocomplete="off" autocapitalize="off" spellcheck="false">
                        <div id="quiz-feedback" class="absolute w-full text-center mt-2 text-sm font-bold opacity-0 transition-opacity"></div>
                    </div>

                    <div id="quiz-actions" class="hidden animate-bounce-in">
                        <button onclick="nextQuestion()" class="w-full bg-green-500 hover:bg-green-600 text-white text-lg font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300">
                            ä¸‹ä¸€é¡Œ â”
                        </button>
                        <p class="text-xs text-gray-400 mt-2">æŒ‰ä¸‹ Enter ç¹¼çºŒ</p>
                    </div>
                </div>

                <!-- ç„¡è³‡æ–™æç¤º -->
                <div id="quiz-empty-msg" class="hidden text-center">
                    <p class="text-xl text-gray-500 mb-4">æ²’æœ‰å–®å­—å¯è€ƒ</p>
                    <button onclick="switchTab('manage')" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        å»æ–°å¢å–®å­—
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- è³‡æ–™èˆ‡ç‹€æ…‹ ---
        const STORAGE_KEY = 'vocab_shuffle_v1';
        let words = [];
        let quizQueue = []; // å¾…è€ƒä½‡åˆ— (æ´—ç‰Œç”¨)
        let currentWord = null;

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { words = JSON.parse(saved); } catch(e) { words = []; }
            }
            renderList();
            document.getElementById('input-spelling').focus();
        });

        // --- æ´—ç‰Œæ¼”ç®—æ³• (Fisher-Yates Shuffle) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- è£œå……é¡Œåº« (ç•¶é¡Œç›®è€ƒå®Œä¸€è¼ªæ™‚) ---
        function refillQueue() {
            if (words.length === 0) return;
            // è¤‡è£½ä¸€ä»½æ‰€æœ‰å–®å­—ä¸¦æ´—ç‰Œ
            quizQueue = shuffleArray([...words]);
            updateQueueUI();
            
            // å¯é¸ï¼šé¡¯ç¤ºã€Œæ–°ä¸€è¼ªé–‹å§‹ã€çš„æç¤º
            // console.log("æ–°ä¸€è¼ªæ´—ç‰Œå®Œæˆ");
        }

        // --- æ¸¬é©—é‚è¼¯ ---
        function nextQuestion() {
            // å¦‚æœç¸½è¡¨æ²’å­—
            if (words.length === 0) {
                initQuizMode(); // è§¸ç™¼ç©ºç‹€æ…‹é¡¯ç¤º
                return;
            }

            // å¦‚æœå¾…è€ƒä½‡åˆ—ç©ºäº†ï¼Œé‡æ–°æ´—ç‰Œå¡«æ»¿
            if (quizQueue.length === 0) {
                refillQueue();
            }

            // å–å‡ºä½‡åˆ—ä¸­çš„æœ€å¾Œä¸€å€‹
            currentWord = quizQueue.pop();
            updateQueueUI();

            // UI é‡ç½®
            const input = document.getElementById('quiz-input');
            const feedback = document.getElementById('quiz-feedback');
            const actions = document.getElementById('quiz-actions');

            input.value = '';
            input.disabled = false;
            input.className = "w-full text-center text-3xl font-mono border-b-2 border-gray-300 bg-transparent focus:border-blue-500 outline-none py-3 transition-colors placeholder-gray-300";
            
            feedback.style.opacity = '0';
            actions.classList.add('hidden');

            document.getElementById('quiz-meaning').textContent = currentWord.meaning;
            document.getElementById('quiz-pos').textContent = currentWord.pos;

            setTimeout(() => input.focus(), 50);
        }

        function updateQueueUI() {
            // è¨ˆç®—é€²åº¦æ¢ (ç¸½æ•¸ - å‰©é¤˜ / ç¸½æ•¸)
            const total = words.length || 1;
            const remaining = quizQueue.length;
            const progress = ((total - remaining) / total) * 100;
            
            document.getElementById('queue-count').textContent = remaining;
            document.getElementById('round-progress').style.width = `${progress}%`;
        }

        // --- è¼¸å…¥æª¢æŸ¥é‚è¼¯ ---
        document.getElementById('quiz-input').addEventListener('input', function(e) {
            if (!currentWord) return;
            
            const val = e.target.value; 
            const target = currentWord.spelling;
            const feedback = document.getElementById('quiz-feedback');
            
            // 1. ç­”å°
            if (val === target) {
                e.target.disabled = true;
                e.target.classList.remove('border-gray-300', 'focus:border-blue-500', 'border-red-500');
                e.target.classList.add('border-green-500', 'text-green-600');
                
                feedback.textContent = 'Correct! ' + target;
                feedback.className = 'absolute w-full text-center mt-2 text-sm font-bold text-green-600 opacity-100';
                
                document.getElementById('quiz-actions').classList.remove('hidden');
                document.querySelector('#quiz-actions button').focus();
                return;
            }

            // 2. ç­”éŒ¯ (å‰ç¶´ä¸å°)
            if (!target.startsWith(val)) {
                e.target.classList.add('border-red-500', 'text-red-600', 'shake');
                e.target.classList.remove('border-gray-300', 'focus:border-blue-500');
                
                feedback.textContent = 'Spelling Error...';
                feedback.className = 'absolute w-full text-center mt-2 text-sm font-bold text-red-500 opacity-100';
                
                setTimeout(() => e.target.classList.remove('shake'), 300);
            } else {
                // 3. è¼¸å…¥ä¸­
                e.target.classList.remove('border-red-500', 'text-red-600');
                e.target.classList.add('border-gray-300', 'focus:border-blue-500');
                feedback.style.opacity = '0';
            }
        });

        // Enter éµæ”¯æ´
        document.addEventListener('keydown', (e) => {
            const quizView = document.getElementById('view-quiz');
            const actions = document.getElementById('quiz-actions');
            
            // åœ¨æ¸¬é©—é é¢ä¸”ç­”å°æ™‚æŒ‰ Enter -> ä¸‹ä¸€é¡Œ
            if (e.key === 'Enter' && !quizView.classList.contains('hidden') && !actions.classList.contains('hidden')) {
                nextQuestion();
            }
        });

        // --- ç®¡ç†é é¢é‚è¼¯ ---
        document.getElementById('add-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const s = document.getElementById('input-spelling').value.trim();
            const m = document.getElementById('input-meaning').value.trim();
            const p = document.getElementById('input-pos').value.trim();
            if(!s || !m) return;

            words.unshift({ id: Date.now(), spelling: s, meaning: m, pos: p });
            saveData();
            renderList();
            
            // ç•¶æ–°å¢å–®å­—æ™‚ï¼Œå¦‚æœæ¸¬é©—éšŠåˆ—æ˜¯ç©ºçš„ï¼Œæˆ–æ˜¯å¸Œæœ›é‡ç½®æ¸¬é©—æµï¼Œå¯ä»¥åœ¨æ­¤è™•è™•ç†
            // é€™è£¡é¸æ“‡ä¸å¼·åˆ¶é‡ç½®éšŠåˆ—ï¼Œè®“ä½¿ç”¨è€…è€ƒå®Œé€™è¼ªå†é‡åˆ°æ–°å­—ï¼Œæˆ–è€…ä½¿ç”¨è€…æ‰‹å‹•åˆ·æ–°
            // ç‚ºäº†é¿å…æ–°å­—ä¸€ç›´è€ƒä¸åˆ°ï¼Œæˆ‘å€‘é€™è£¡åšä¸€å€‹ç°¡å–®è™•ç†ï¼šè‹¥ä½‡åˆ—å·²ç©ºï¼Œä¸‹æ¬¡nextQuestionæœƒè‡ªå‹•æŠŠæ–°å­—åŠ é€²ä¾†æ´—ç‰Œ
            
            e.target.reset();
            document.getElementById('input-spelling').focus();
        });

        function deleteWord(id) {
            words = words.filter(w => w.id !== id);
            saveData();
            renderList();
            // åˆªé™¤å–®å­—ä¹Ÿè¦åŒæ­¥å¾å¾…è€ƒæ¸…å–®ç§»é™¤ï¼Œé¿å…è€ƒåˆ°ä¸å­˜åœ¨çš„å­—
            quizQueue = quizQueue.filter(w => w.id !== id);
            updateQueueUI();
        }

        function renderList() {
            const tbody = document.getElementById('word-list-body');
            const emptyMsg = document.getElementById('list-empty-msg');
            const count = document.getElementById('word-count');

            tbody.innerHTML = '';
            count.textContent = words.length;

            if (words.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                words.forEach(w => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-3 font-mono text-blue-700">${w.spelling}</td>
                        <td class="p-3">${w.meaning}</td>
                        <td class="p-3"><span class="bg-gray-200 text-xs px-2 py-1 rounded">${w.pos}</span></td>
                        <td class="p-3 text-right">
                            <button onclick="deleteWord(${w.id})" class="text-gray-300 hover:text-red-500 font-bold px-2">âœ•</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function resetData() {
            if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³‡æ–™å—ï¼Ÿ')) {
                words = [];
                quizQueue = [];
                saveData();
                renderList();
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(words));
        }

        // --- é é¢åˆ‡æ› ---
        function switchTab(tab) {
            const vManage = document.getElementById('view-manage');
            const vQuiz = document.getElementById('view-quiz');
            const bManage = document.getElementById('btn-manage');
            const bQuiz = document.getElementById('btn-quiz');

            if (tab === 'manage') {
                vManage.classList.remove('hidden');
                vQuiz.classList.add('hidden');
                updateTabStyle(bManage, true);
                updateTabStyle(bQuiz, false);
                setTimeout(() => document.getElementById('input-spelling').focus(), 50);
            } else {
                vManage.classList.add('hidden');
                vQuiz.classList.remove('hidden');
                updateTabStyle(bManage, false);
                updateTabStyle(bQuiz, true);
                initQuizMode();
            }
        }

        function initQuizMode() {
            const card = document.getElementById('quiz-card-container');
            const empty = document.getElementById('quiz-empty-msg');
            
            if (words.length === 0) {
                card.classList.add('hidden');
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                card.classList.remove('hidden');
                
                // åªæœ‰ç•¶æ²’é¡Œç›®åœ¨æ‰‹ä¸Šæ™‚ï¼Œæ‰æŠ½ä¸‹ä¸€é¡Œ
                if (!currentWord || document.getElementById('quiz-actions').classList.contains('hidden') === false) {
                    nextQuestion();
                }
            }
        }

        function updateTabStyle(btn, active) {
            if (active) {
                btn.className = "px-5 py-2 rounded-md text-sm font-bold transition-all shadow-sm bg-blue-600 text-white";
            } else {
                btn.className = "px-5 py-2 rounded-md text-sm font-bold transition-all text-gray-600 hover:bg-gray-200";
            }
        }
    </script>
</body>
</html>
